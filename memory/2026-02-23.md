# Session Log — 2026-02-23

## ticker-watch: Full Day Session

### Morning Work (pre-compact)
- Extended VCP hold 30→60d + day-30 soft stop; EV +0.394R → +0.520R
- 1-min bar OHLC for live stop/target detection
- 60s min-hold guard + cancel-on-conflict for options orders
- NEWS_TELEGRAM_ALERTS = False
- ORB-FVG: 4:1 R:R, UNIVERSE_ORB 5 tickers, full 16-combo backtest (best: Var C ORB-only 4:1 +0.293R)
- ORB full backtest confirmed and pushed; MEMORY.md updated

### Afternoon Work

#### DB P&L Fixes — All Done ✅
- `reconcile_alpaca_fills()` now sets `pnl_r = (fill_exit - fill_entry) / fill_entry`
- Cancelled/no-fill trades zeroed to 0.0R
- `scripts/patch_pnl_r.py` ran — 7 records corrected:
  - GOOGL: -1.0R → +1.6429R | IWM: +3.0R → +1.5164R | META: +3.0R → +0.0554R
  - SPY: +3.0R → -0.1667R | TSLA: +3.0R → -0.1536R | MSFT: -1.0R → -0.0699R
  - AMZN: cancelled/no-fill → 0.0R
- Live performance (corrected): 6 trades, 50% WR, avg win +1.07R, avg loss -0.13R, EV +0.47R/trade
- Total day P&L: +$11,573 | DB balance: $26,687 (started $15k)
- Commit: `bd1a73b`

#### Duplicate Log Lines — Fixed ✅
- Root cause: FileHandler(scanner.log) + shell `>> scanner.log` redirect doubled every line
- Fix: deploy_scanner.sh --background now uses `> /dev/null` (FileHandler is sole writer)
- Commit: `ab48388`

#### Scanner Crash Resilience — Fixed ✅
- Root cause: `while True` in run_scanner() had no top-level exception handler; stderr → /dev/null
- Fix 1: deploy_scanner.sh now redirects stderr → `logs/scanner_stderr.log`
- Fix 2: `__main__` daemon mode wraps `run_scanner()` in restart loop (crash → log traceback → sleep 15s → restart)
- Watchdog prompt updated: now pulls `scanner_stderr.log` + `[DAEMON]` crash lines when restarting
- Commit: `4917670`

#### Gateway Dashboard — Fixed ✅
- Root cause: `bind: tailnet` falls back to 127.0.0.1 inside container (no Tailscale interface)
- Fix: changed to `bind: lan` → gateway binds to 0.0.0.0 (Docker port mapping works)
- Access: `http://100.83.232.127:18789/overview` via Tailscale on host
- Security: host not internet-exposed; token auth sufficient for Tailscale-only access
- Could tighten Docker mapping to `100.83.232.127:18789:18789` if desired

#### 100 Contract Cap — Added ✅
- `RISK_CONFIG["max_contracts"] = 100` in paper_trade_manager.py
- Prevents SPY-style runaway qty on cheap options ($0.06 → 201 contracts was too much)
- Commit: `0e467e1`

#### README — Rewritten ✅
- Old README was original design doc (Polygon, double tops, wedges). Replaced with actual state.
- Commit: `82dd236`

#### Bull Flag 15min — Backtested & Live ✅
- Baseline EV: +0.255R (vs Bull Flag 5min: -0.081R) — positive baseline, much better
- Filtered EV: +0.264R (filters barely help with current stack)
- Key finding: bar quality suppress kills +0.296R EV winners for bull flags; KL amplify hurts (0.188R vs neutral 0.331R)
- Option A (chosen): disable bar quality + KL amplify; keep S/D suppress + KL suppress + earnings blackout
- Added to live_scanner.py: CALL, ATM, Weekly 2-7 DTE, skip IVR > 50
- run_combined_backtest.py updated: Bull Flag 5min replaced with 15min
- Commit: `1064721`

#### Schwab API — Connected ✅
- schwab-py installed: `pip install --break-system-packages schwab-py`
- `src/data/schwab_client.py` created: OAuth2 client, get_daily_bars(), get_intraday_bars(), get_option_chain()
- Auth completed, token saved to `config/schwab_token.json`
- Verified: AAPL daily bars fetching correctly
- Keys in config/config.yaml (gitignored)
- Purpose: historical backtesting data; plan to replace Alpaca/yfinance eventually
- Commit: `1212b1b`

### Active Strategies (End of Day)
| Strategy | EV | Options | Status |
|----------|----|---------|--------|
| Bear Flag 15min | +1.256R | PUT, ATM, Weekly 2-7 DTE, IVR<50 | ✅ Live |
| Bull Flag 15min | +0.264R | CALL, ATM, Weekly 2-7 DTE, IVR<50 | ✅ NEW |
| IB Bull (swing) | +0.440R | CALL, ATM Δ0.50, ~35 DTE, IVR<45 | ✅ Live |
| IB Bear (swing) | +0.208R | PUT, ATM, ~35 DTE, IVR<40 | ✅ Live |
| VCP | +0.553R | CALL, ATM, ~35 DTE | ✅ Live |
| ORB-FVG Var C | +0.293R | CALL/PUT, 35 DTE | ✅ Live |

### Scanner Status (End of Day)
- PID 1914, running clean, no crashes since resilience fix
- Watchdog checks every 15min (7am-4pm MT weekdays), now reports crash reason
- Market closed; resumes tomorrow at open

### All Commits Today
`9fada80` `f088eed` `809db2a` `517cebd` `7967716` `cc075fa` `c9c56d1`
`bd1a73b` `ab48388` `4917670` `0e467e1` `82dd236` `f0f9476` `1212b1b` `1064721`

## Remaining Items (Low Priority)
- Option B ticker sweep for Bull Flag 15min (would push EV ~+0.5R by filtering AAPL/AMZN/NVDA)
- Auto-restart on container reboot (systemd/Docker) — watchdog is sufficient safety net for now
- Reconcile Alpaca equity ($111k paper) vs DB balance ($26k) — different seed amounts, not critical
